@page "/"
@rendermode InteractiveServer
@inject IConfiguration Configuration
@inject IJSRuntime js
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject CosmosDbService cosmosDbService
@inject AIChatDBContext dbContext
@inject UserService userService

@using Azure
@using Azure.AI.DocumentIntelligence
@using Azure.Search.Documents.Indexes
@using Azure.Search.Documents.Indexes.Models
@using Azure.Storage.Blobs
@using Azure.Storage.Blobs.Models
@using BlazorAIChat.Components.Shared
@using BlazorAIChat.Models
@using BlazorAIChat.Utils
@using BlazorAIChat.Services
@using Microsoft.AspNetCore.Components.Authorization
@using MarkdownSharp
@using Microsoft.SemanticKernel
@using Microsoft.SemanticKernel.ChatCompletion
@using Microsoft.SemanticKernel.Connectors.OpenAI
@using Microsoft.SemanticKernel.Connectors.Sqlite
@using Microsoft.SemanticKernel.Embeddings
@using Microsoft.SemanticKernel.Memory
@using Microsoft.KernelMemory
@using System.Text
@using System.Text.RegularExpressions
@using System.Text.Json
@using System.Net.Http.Headers
@using System.Security.Claims

<PageTitle>Azure Open AI Chat Demo</PageTitle>
<Alert AlertType="@alertType" AlertMessage="@alertMessage" OnClose="CloseAlert" />
@if (showNeedsConfigure)
{
    <div class="d-flex justify-content-center align-items-center vh-100">
        <div class="card" style="max-width: 700px; width: 100%;">
            <div class="card-header">
                <h5 class="card-title">Configuration Required</h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    To complete the application deployment, you must enable authentication on the Azure App Service or you must set RequireEasyAuth to false in the App Service configuration or appsettings.json file.<br /><br />
                    Setting RequireEasyAuth to false will allow anonymous users to access the application. This also means that all chat history and uploaded knowledge will be shared with all users.
                </p>
            </div>
        </div>
    </div>

}
else if (userService.DoesUserNeedToRequestAccess(currentUser, config, RequireEasyAuth))
{
    <div class="d-flex justify-content-center">
        <div class="card" style="max-width: 700px; width: 100%;">
            <div class="card-header">
                <h5 class="card-title">Request Access</h5>
            </div>
            <div class="card-body">
                <p class="card-text">
                    You do not currently have access to this page. If you would like to request access, click on the button below. All requests will be reviewed by the administrator.
                </p>
                <button class="btn btn-primary" @onclick="RequestAccess">Request Access</button>
            </div>
        </div>
    </div>
}
else
{
    @if (userService.IsUserAccountExpired(currentUser, config, RequireEasyAuth))
    {
        <div class="row">
            <div class="col-md-12">
                Your account has expired. Please contact the administrator to renew your account.
            </div>
        </div>
    }
    else
    {
        <div class="h-100 d-flex flex-row justify-content-start">
        @if (!IsNavMenuCollapsed)
        {
            <div class="sidebar">
                <NavMenu @ref="@NavMenu" OnChatClicked="LoadChatEventHandlerAsync" User="@currentUser" OnNavBarVisibilityUpdated="UpdateNavBarVisibility" />
            </div>
        }

        <div class="flex-grow-1">
            <div class="h-100 mh-100 d-flex flex-column overflow-hidden justify-content-start">
                    <div class="navbar navbar-dark bg-primary">
                        <div class="w-100 navbar navbar-dark bg-primary d-flex flex-row px-4 justify-content-between flex-nowrap">
                            <div class="d-flex flex-row justify-content-start">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500" height="30" fill="currentColor" class="text-light">
                                    <path d="M415.98 265.82v-.27a17.24 17.24 0 1 0 .01.27ZM224.4 321.87a17.24 17.24 0 1 0 34.48 0 17.24 17.24 0 0 0-34.48 0Z" />
                                    <path d="M397.92 209.51C395.91 95.77 266.41 51.59 182.48 96.66l-.12 145.45a5.39 5.39 0 0 0 5.39 5.39h41.76a18.85 18.85 0 0 1 18.86 18.86v25.6a29.36 29.36 0 1 1-36.1 28.56 29.1 29.1 0 0 1 22.9-28.56v-26.94a5.65 5.65 0 0 0-5.66-5.66h-41.76a18.59 18.59 0 0 1-18.59-18.59v-135.9c-21.08 14.76-38.2 36.03-47.96 64.23-163.09 22.89-139.5 256.6 22.91 252.74h14.81V305.98a5.39 5.39 0 0 0-5.39-5.39h-23.71a29.36 29.36 0 1 1 0-13.2h23.71a18.59 18.59 0 0 1 18.59 18.59v115.86h148.46V210.59a5.39 5.39 0 0 0-5.39-5.39h-28.83a29.36 29.36 0 1 1-28.56-36.1 29.1 29.1 0 0 1 28.56 22.9h27.75a18.59 18.59 0 0 1 18.59 18.59v94.84h53.89a5.66 5.66 0 0 0 5.66-5.66v-5.39a29.38 29.38 0 0 1 6.73-57.94l1.1-.02a29.37 29.37 0 0 1 29.35 29.39 29.36 29.36 0 0 1-22.9 28.56v5.39a18.85 18.85 0 0 1-18.86 18.86h-53.89v103.2h43.38c61.49 2.64 114.03-46.08 115.32-107.78-1.2-53.49-41.47-98-94.58-104.54Z" />
                                    <circle cx="101" cy="293.85" r="17.24" />
                                    <circle cx="257.81" cy="198.46" r="17.24" />
                                    <path d="m182.49 96.66-.07.05.07-.04Z" />
                                </svg>
                                <span class="navbar-brand mb-0 ms-1 h1">Blazor Azure OpenAI Chat</span>
                                @currentSession?.Id
                            </div>
                        </div>
                    </div>

                    <div class="px-4 pb-4 pt-2 flex-grow-1 overflow-y-auto overflow-x-hidden align-items-stretch" id="MessagesInChatdiv">
                        @if (currentSession is null)
                        {
                            <div class="alert alert-primary">
                                <div class="alert-heading">
                                    <div class="spinner-border text-primary me-1" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    Loading...
                                </div>
                                <p class="text-nowrap mb-0 fst-italic">
                                    Please wait while your chat loads.
                                </p>
                            </div>
                        }
                        else if (currentSession.SessionId == Models.Constants.EMPTY_SESSION)
                        {
                            <div class="alert alert-warning">
                                <h4 class="alert-heading">
                                    <i class="bi bi-exclamation-triangle-fill me-1" aria-hidden="true"></i>
                                    No Chats Available
                                </h4>
                                <p class="text-nowrap mb-0 fst-italic">
                                    Use the New Chat option to start a new chat.
                                </p>
                            </div>
                        }
                        else
                        {
                            if (messagesInChat is null || loadingComplete == false)
                            {
                                <div class="alert alert-primary">
                                    <div class="alert-heading">
                                        <div class="spinner-border text-primary me-1" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        Loading...
                                    </div>
                                    <p class="text-nowrap mb-0 fst-italic">
                                        Please wait while your chat loads.
                                    </p>
                                </div>
                            }
                            else
                            {
                                if (messagesInChat.Count == 0)
                                {
                                    <div class="alert alert-info">
                                        <h4 class="alert-heading">
                                            <i class="bi bi-lightbulb-fill me-1" aria-hidden="true"></i>
                                            Get Started
                                        </h4>
                                        <p class="text-nowrap mb-0 fst-italic">
                                            Start chatting with your helpful AI assistant.
                                        </p>
                                    </div>
                                }
                                else
                                {
                                    <div class="toast-container position-static w-100 d-flex flex-column align-items-stretch">
                                        @foreach (var msg in messagesInChat)
                                        {
                                            <div class="toast fade show w-75 rounded-3 align-self-start">
                                                <div class="toast-header bg-primary text-light">
                                                    <i class="bi bi-person me-1" aria-hidden="true"></i>
                                                    <strong class="me-auto text-capitalize">User</strong>
                                                </div>
                                                <div class="toast-body">
                                                    <i class="bi bi-grip-vertical mr-2 text-black-50"></i>
                                                     @(new MarkupString(msg.Prompt))
                                                </div>
                                            </div>
                                            <div class="toast fade show w-75 rounded-3 align-self-end">
                                                <div class="toast-header bg-success text-dark">
                                                    <i class="bi bi-robot me-1" aria-hidden="true"></i>
                                                    <strong class="me-auto text-capitalize">Assistant</strong>
                                                </div>
                                                <div class="toast-body">
                                                    <i class="bi bi-grip-vertical mr-2 text-black-50"></i>
                                                    <span class="display: inline">
                                                        @(new MarkupString(StripOuterParagraphTags(msg.Completion)))
                                                    </span>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        }
                    </div>
                    <div class="bg-primary text-light px-4 py-2 rounded-top-5 text-dark d-flex flex-column justify-content-center">
                        @if (currentSession is not null && currentSession?.SessionId != Models.Constants.EMPTY_SESSION)
                        {
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Enter your message" disabled="@isResponding" @bind-value="userMessage" @bind-value:event="oninput" @onkeydown="HandleKeyDown" />
                                <button class="btn btn-primary" @onclick="SendMessage">Send</button>
                                <InputFile @ref="inputFile" class="btn btn-warning" OnChange="HandleFileSelected" disabled="@(isFileInputDisabled||isResponding)" />
                                <button class="btn btn-secondary" @onclick="Clear">@clearCancelText</button>
                            </div>                    
                        }
                    </div>
                </div>
            </div>
        </div>
   
    <CustomModal IsVisible="isFileInputDisabled" Title="Document Processing" Message="Please wait, the document is uploading and processing. The amount of time this takes depends upon the size of the document." />
    }
}

@code {

    private bool loadingComplete = false;
    private NavMenu? NavMenu = default;
    private bool IsNavMenuCollapsed { get; set; }
    private Session? currentSession;
    private List<Message>? messagesInChat;

    #pragma warning disable SKEXP0010, SKEXP0001, SKEXP0020
    private Config config = new Config(){ Id=Guid.Empty};

    private IBrowserFile? selectedFile = null;
    private string newResponse = string.Empty;
    private string userMessage = string.Empty;
    private IKernelBuilder? builder = null;
    private Kernel? kernel = null;
    private MemoryServerless? kernelMemory = null;
    private IChatCompletionService? chatCompletionService = null;
    private ChatHistory history = new ChatHistory();
    Markdown md = new Markdown();

    bool showNeedsConfigure = false;
    bool isFileInputDisabled=false;
    bool isResponding = false;
    bool stopResponding = false;

    private ElementReference chatWindow;
    private InputFile? inputFile;

    bool RequireEasyAuth = false;
    User currentUser = new User() { Id=string.Empty };

    private string alertMessage { get; set; } = string.Empty;
    private string alertType { get; set; } = string.Empty;

    string clearCancelText = "Clear";

    const long maxFileSizeBytes = 1073741824; // 1GB
    string welcomeMessage = string.Empty;

    bool chatModelSupportsImages = false;
    byte[]? uploadImageByteArray = null;
    string uploadImageType= string.Empty;

    string systemMessage = "You are a helpful AI assistant. Respond in a friendly and professional tone.";
    string documentIntelligenceEndpoint= string.Empty;
    string documentIntelligenceApiKey = string.Empty;
    string azureStorageConnectionString = string.Empty;
    string aiSearchEndpoint = string.Empty;
    string aiSearchApiKey = string.Empty;
    string cosmosDbConn = string.Empty;
    string postgreSqlDbConn = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        NavMenu = new NavMenu();

        try
        {
            currentUser = await userService.GetCurrentUserAsync();

        }
        catch (Exception ex)
        {
            Console.WriteLine($"Initialization error: {ex.Message}");
        }

        try
        {
            // Get settings from appsettings.json or App Service configuration
            var endpoint = Configuration["AzureOpenAIChatCompletion:Endpoint"] ?? string.Empty;
            var apiKey = Configuration["AzureOpenAIChatCompletion:ApiKey"] ?? string.Empty;
            var model = Configuration["AzureOpenAIChatCompletion:Model"] ?? string.Empty;
            var embedModel = Configuration["AzureOpenAIEmbedding:Model"] ?? string.Empty;
            postgreSqlDbConn = Configuration["ConnectionStrings:PostgreSQL"] ?? string.Empty;
            chatModelSupportsImages = bool.Parse(Configuration["AzureOpenAIChatCompletion:SupportsImages"] ?? "false");
            RequireEasyAuth = bool.Parse(Configuration["RequireEasyAuth"] ?? "false");
            systemMessage = Configuration["SystemMessage"] ?? systemMessage;
            documentIntelligenceEndpoint = Configuration["DocumentIntelligence:Endpoint"] ?? string.Empty;
            documentIntelligenceApiKey = Configuration["DocumentIntelligence:ApiKey"] ?? string.Empty;
            azureStorageConnectionString = Configuration["ConnectionStrings:AzureStorage"] ?? string.Empty;
            aiSearchEndpoint = Configuration["AzureAISearch:Endpoint"] ?? string.Empty;
            aiSearchApiKey = Configuration["AzureAISearch:ApiKey"] ?? string.Empty;

            //Verify if the App Service needs configuration.
            if (currentUser.Id=="Guest User" && RequireEasyAuth)
            {
                showNeedsConfigure = true;
                StateHasChanged();
                return;
            }

            //Get app config data
            var dbConfig = dbContext.Config.FirstOrDefault();
            if (dbConfig != null)
                config = dbConfig;       

            //Setup the welcome message
            welcomeMessage = $"Welcome to the Azure OpenAI Chat demo! You can ask your questions using the text box below. Additionally, you can upload DOCX, PDF, XLSX, {(chatModelSupportsImages?"Images, ":string.Empty)} or TXT files (up to 1GB) to ask questions about their content.<br/>";

            // Create a kernel with Azure OpenAI chat completion
            builder = Kernel.CreateBuilder()
            .AddAzureOpenAIChatCompletion(model, endpoint, apiKey)
            .AddAzureOpenAITextEmbeddingGeneration(embedModel, endpoint, apiKey);

            // Add enterprise components
            builder.Services.AddLogging(services => services.AddConsole().SetMinimumLevel(LogLevel.Trace));

            // Build the kernel
            kernel = builder.Build();

            //get current file directory
            var knnDirectory = "KNN";

            var kernelMemoryBuilder = new KernelMemoryBuilder()
            .WithAzureOpenAITextEmbeddingGeneration(new AzureOpenAIConfig
                {
                    APIType = AzureOpenAIConfig.APITypes.EmbeddingGeneration,
                    Endpoint = endpoint,
                    Deployment = embedModel,
                    Auth = AzureOpenAIConfig.AuthTypes.APIKey,
                    APIKey = apiKey,
                })
            .WithAzureOpenAITextGeneration(new AzureOpenAIConfig
                {
                    APIType = AzureOpenAIConfig.APITypes.ChatCompletion,
                    Endpoint = endpoint,
                    Deployment = model,
                    Auth = AzureOpenAIConfig.AuthTypes.APIKey,
                    APIKey = apiKey,
                });


            //If Azure AI Search is configured, we use that for storage
            if (!string.IsNullOrEmpty(aiSearchEndpoint) && !string.IsNullOrEmpty(aiSearchApiKey))
            {
                kernelMemoryBuilder = kernelMemoryBuilder.WithAzureAISearchMemoryDb(new AzureAISearchConfig()
                {
                    Endpoint = aiSearchEndpoint,
                    APIKey = aiSearchApiKey,
                    Auth = AzureAISearchConfig.AuthTypes.APIKey,
                    UseHybridSearch = false
                });

            }
            else if (string.IsNullOrEmpty(postgreSqlDbConn))
            {
                //Use file memory store
                kernelMemoryBuilder = kernelMemoryBuilder.WithSimpleVectorDb(new Microsoft.KernelMemory.MemoryStorage.DevTools.SimpleVectorDbConfig { StorageType = Microsoft.KernelMemory.FileSystem.DevTools.FileSystemTypes.Disk, Directory = knnDirectory });
            }
            else
            {
                //Use PostgreSQL DB memory store
                //NOTE: You must have enabled pgvector extension in your PostgreSQL database for this to work.
                kernelMemoryBuilder = kernelMemoryBuilder.WithPostgresMemoryDb(new PostgresConfig()
                {
                    ConnectionString= postgreSqlDbConn    
                });
            }

            //Configure document intelligence if configured
            if (!chatModelSupportsImages && !string.IsNullOrEmpty(documentIntelligenceEndpoint) && !string.IsNullOrEmpty(documentIntelligenceApiKey))
            {
                kernelMemoryBuilder = kernelMemoryBuilder.WithAzureAIDocIntel(new AzureAIDocIntelConfig()
                    {
                        Endpoint = documentIntelligenceEndpoint,
                        APIKey = documentIntelligenceApiKey,
                        Auth= AzureAIDocIntelConfig.AuthTypes.APIKey
                    });
            }

            kernelMemory = kernelMemoryBuilder.Build<MemoryServerless>();

            //Get reference to the chat completion service
            chatCompletionService = kernel.GetRequiredService<IChatCompletionService>();

            //Get the current session chat messages
            await ReloadChatMessagesAsync();

            //Clear the chat history and set the system message
            internalClear();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Initialization error: {ex.Message}");
            ShowAlert($"An error occurred while initializing the chat. {ex.Message}", AlertTypeEnum.danger);
        }
    }

    private void UpdateNavBarVisibility()
    {
        IsNavMenuCollapsed = !IsNavMenuCollapsed;
    }

    private async void Clear()
    {
        //If this is called when the AI is responding, then stop the response, otherwise clear the chat
        if (isResponding)
        {
            stopResponding = true;
            clearCancelText = "Clear";
        }
        else
        {
            internalClear();

            //clear the value from inputFile
            if (inputFile != null)
            {
                await js.InvokeVoidAsync("clearElementValue", inputFile.Element);
            }

            bool confirmed = await js.InvokeAsync<bool>("confirm", "Click OK to delete previously uploaded documents. Click cancel to only clear chat to start a new conversation.");

            //if the user confirms, delete the memory store
            if (confirmed)
            {

                if (kernelMemory!=null)
                    await kernelMemory.DeleteIndexAsync(currentUser.Id.Replace(" ", ""));

                ShowAlert("All documents have been removed.", AlertTypeEnum.info);
            }
        }
    }

    private void internalClear()
    {
        messagesInChat = new List<Message>();
        uploadImageByteArray = null;
        uploadImageType = string.Empty;
        userMessage = string.Empty;
        history = new ChatHistory();
        history.AddSystemMessage(systemMessage);
        StateHasChanged();
    }

    private async Task SendMessage()
    {
        try
        {
            if (!string.IsNullOrWhiteSpace(userMessage) && chatCompletionService != null && currentSession!=null)
            {

                //The user previously requested to stop responding, so reset the flag so it can respond to the new message
                stopResponding = false;

                Message message = new Message(currentSession.Id, userMessage);
                messagesInChat.Add(message);

                //We do this to ensure that the user message is displayed in the chat window since looking up kernelMemory may take a moment. We
                //want the UI to feel responsive.
                string messageToProcess = userMessage;
                userMessage = string.Empty;
                StateHasChanged();

                //Look up possible knowledge from the memory store
                var answer = await kernelMemory!.AskAsync(messageToProcess, currentUser.Id.Replace(" ", ""));

                if (!answer.NoResult)
                {
                    history.AddUserMessage("Here is some supporting information:");
                    history.AddUserMessage(answer.Result);
                    history.AddUserMessage("----------------------------------");
                }

                //Save the user message to the memory store
                if (uploadImageByteArray==null)
                {
                    history.AddUserMessage(messageToProcess);
                }
                else
                {
                    var sendMessage = new ChatMessageContentItemCollection
                    {
                        new TextContent(messageToProcess),
                        new ImageContent(){Data=uploadImageByteArray, MimeType = uploadImageType }
                    };
                    history.AddUserMessage(sendMessage);
                }

                await StreamChatCompletionAsync(history,message, chatCompletionService);
                await js.InvokeVoidAsync("scrollToBottom", "MessagesInChatdiv");

            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"SendMessage error: {ex.Message}");
            ShowAlert($"An error occurred while sending the message. {ex.Message}", AlertTypeEnum.danger);
        }
    }

    public async Task StreamChatCompletionAsync(ChatHistory history,Message message, IChatCompletionService chatCompletionService)
    {
        try
        {
            var markdownBuilder = new StringBuilder();
            var finalResults = new StringBuilder();
            isResponding = true;
            clearCancelText = "Stop";
            await foreach (var chatUpdate in chatCompletionService.GetStreamingChatMessageContentsAsync(history))
            {
                //If the user has requested to stop responding, then break out of the loop
                if (stopResponding)
                {
                    clearCancelText = "Clear";
                    break;
                }

                //If the chat update has content, then append it to the results
                if (chatUpdate?.Content != null)
                {
                    finalResults.Append(chatUpdate.Content);
                    markdownBuilder.Append(chatUpdate.Content);
                    string partialHTML = md.Transform(markdownBuilder.ToString());

                    message.Completion = FixupTextForCode(partialHTML.ToString());
                    newResponse = "<b>assistant</b>: " + partialHTML.ToString();
                    // Scroll to the bottom of the chat window
                    await js.InvokeVoidAsync("scrollToBottom", "MessagesInChatdiv");
                    StateHasChanged();
                }
            }
            newResponse = string.Empty;
            message.Completion = md.Transform(FixupTextForCode(finalResults.ToString()));
            history.AddAssistantMessage(finalResults.ToString());

            //store the chat session history
            await UpdateSessionAndMessage(currentSession?.Id??string.Empty, message);

            // Scroll to the bottom of the chat window
            await js.InvokeVoidAsync("scrollToBottom", "MessagesInChatdiv");
            isResponding = false;
            clearCancelText = "Clear";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            isResponding = false;
            clearCancelText = "Clear";
            StateHasChanged();
            Console.WriteLine($"StreamChatCompletionAsync error: {ex.Message}");
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;

        if (!string.IsNullOrEmpty(selectedFile.Name) && selectedFile.Size > 0)
        {
            await UploadFile();

            selectedFile= null;
        }
        else
        {
            ShowAlert("The file you selected is empty or has no name.", AlertTypeEnum.warning);
        }

        if (selectedFile!=null && selectedFile.Size>maxFileSizeBytes)
        {
            ShowAlert("The file you selected is too large. Please select a file that is less than 1GB.", AlertTypeEnum.warning);
        }
    }

    private async Task UploadFile()
    {
        try
        {
            if (selectedFile == null)
            {
                ShowAlert("You need to select a file to upload.", AlertTypeEnum.warning);
                return;
            }

            // Only upload PDFs, DOCX, and TXT files
            var fileName = selectedFile.Name.ToLower();
            if (!(fileName.EndsWith(".pdf") || fileName.EndsWith(".docx") || fileName.EndsWith(".xlsx") || fileName.EndsWith(".pptx") || fileName.EndsWith(".txt") ||
                  (chatModelSupportsImages && (fileName.EndsWith(".jpg") || fileName.EndsWith(".jpeg") || fileName.EndsWith(".png") || fileName.EndsWith(".gif")))))
            {
                string alertMessage = chatModelSupportsImages || (!string.IsNullOrEmpty(documentIntelligenceEndpoint) && !string.IsNullOrEmpty(documentIntelligenceApiKey))
                    ? "Please upload a PDF, DOCX, XLSX, PPTX, TXT, or image file."
                    : "Please upload a PDF, DOCX, XLSX, PPTX, or TXT file. Image uploads are not supported.";
                ShowAlert($"The file {selectedFile.Name} is not a supported file type. {alertMessage}", AlertTypeEnum.warning);
                return;
            }

            isFileInputDisabled = true;
            StateHasChanged();

            using var stream = selectedFile.OpenReadStream(maxAllowedSize: 1073741824); // 1GB
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);

            //Check to see how we need to process the files. If we are using Azure AI Search, then we will not process the PDF, DOCX, or TXT files
            if (chatModelSupportsImages && (fileName.EndsWith(".jpg") || fileName.EndsWith(".jpeg") || fileName.EndsWith(".png") || fileName.EndsWith(".gif")))
            {
                ProcessImage(memoryStream, fileName);
            }
            else
            {
                await ProcessWithKernelMemory(memoryStream, fileName);
            }

            if (inputFile != null)
            {
                await js.InvokeVoidAsync("clearElementValue", inputFile.Element);
            }
            isFileInputDisabled = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ShowAlert($"An error occurred while uploading the file. {ex.Message}", AlertTypeEnum.danger);
            isFileInputDisabled = false;
            Console.WriteLine($"UploadFile error: {ex.Message}");
        }
    }

    private void ProcessImage(MemoryStream memoryStream, string filename)
    {
        try
        {
            //set the mime type of the image to the uploadImageType string based on the filename
            if (filename.EndsWith(".jpg") || filename.EndsWith(".jpeg"))
            {
                uploadImageType = "image/jpeg";
            }
            else if (filename.EndsWith(".png"))
            {
                uploadImageType = "image/png";
            }
            else if (filename.EndsWith(".gif"))
            {
                uploadImageType = "image/gif";
            }

            uploadImageByteArray = memoryStream.ToArray();

            string base64Image = ConvertByteImageToBase64Data(uploadImageByteArray);
            if (messagesInChat!=null && currentSession!=null)
                messagesInChat.Add(new Message(currentSession.Id, $"<img style='max-height:300px; max-width:300px;' src='{base64Image}'/>","What would you like to know about that image?"));
            StateHasChanged();
            return;

        }
        catch (Exception ex)
        {
            ShowAlert($"An error occurred while processing the image. {ex.Message}", AlertTypeEnum.danger);
            Console.WriteLine($"ProcessImage error: {ex.Message}");
            return;
        }
    }

    private async Task ProcessWithKernelMemory(MemoryStream memoryStream, string filename)
    {
        if (kernelMemory != null)
        {
            var docId = Guid.NewGuid().ToString();
            string index = currentUser.Id.Replace(" ", "");
            TagCollection tags = new TagCollection();
            tags.Add("user", currentUser.Id);
            memoryStream.Position = 0;
            await kernelMemory.ImportDocumentAsync(memoryStream, filename,docId, tags, index);

            while(!await kernelMemory.IsDocumentReadyAsync(docId,index))
            {
                Thread.Sleep(1000);
            }

        }
    }

    private void ShowAlert(string message, AlertTypeEnum alertType= AlertTypeEnum.info)
    {

        alertMessage += message + " ";
        this.alertType = "alert-" + (Enum.GetName(typeof(AlertTypeEnum), alertType)?.ToLower() ?? "warning");
        StateHasChanged();
    }


    private void CloseAlert()
    {
        alertMessage = string.Empty;
        alertType=string.Empty;
        StateHasChanged();
    }

    private string ConvertByteImageToBase64Data(byte[] byteImage)
    {
        return "data:image/png;base64," + Convert.ToBase64String(byteImage);
    }

    private void RequestAccess()
    {

        //check to see if the user already has a request for access
        //if they do, then show a message that they already have a request
        //if they don't, then add a request to the database
        var userDetails = dbContext.Users.FirstOrDefault(u => u.Id==currentUser.Id);
        if (userDetails!=null)
        {
            ShowAlert("You have already requested access to this page.", AlertTypeEnum.warning);
            return;
        }
        else
        {
            //if there are no admins already, then add the user as an admin and auto approve
            if (!dbContext.Users.Any(u => u.Role == UserRoles.Admin))
            {
                dbContext.Users.Add(new User() { Id = currentUser.Id, Name = currentUser.Name, Role = UserRoles.Admin, DateRequested = DateTime.Now, DateApproved=DateTime.Now, ApprovedBy=string.Empty, Email=string.Empty });
                dbContext.SaveChanges();
                currentUser.Role = UserRoles.Admin;
                ShowAlert("Your request for access has been approved and you are the first administrator.", AlertTypeEnum.success);
            }
            else
            {
                dbContext.Users.Add(new User() { Id = currentUser.Id, Name = currentUser.Name, Role = UserRoles.Guest, DateRequested = DateTime.Now });
                dbContext.SaveChanges();
                ShowAlert("Your request for access has been submitted. You will have access once an admin approves the request.", AlertTypeEnum.success);
            }
        }
    }

    private string FixupTextForCode(string text)
    {
        Regex rgx = new Regex("```");
        var matches = rgx.Matches(text);
        if (matches.Count() > 0)
            for (int i = 0; i < matches.Count; i++)
                if (i % 2 == 0)
                    // even = start code block tag
                    text = rgx.Replace(text, "<pre><code>", 1, i);
                else
                    // odd = end code block tag
                    text = rgx.Replace(text, "</pre></code>", 1, i);

        return text;
    }

    public async void LoadChatEventHandlerAsync(Session session)
    {
        loadingComplete = false;
        currentSession = session;
        await ReloadChatMessagesAsync();
    }

    public async Task ReloadChatMessagesAsync()
    {
        if (currentSession is not null)
        {
            messagesInChat = await cosmosDbService.GetSessionMessagesAsync(currentSession.SessionId);
        }

        //setup chat history object
        history = new ChatHistory();
        history.AddSystemMessage(systemMessage);
        if (messagesInChat != null && messagesInChat.Count > 0)
        {
            foreach (var msg in messagesInChat)
            {
                history.AddUserMessage(msg.Prompt); 
                history.AddAssistantMessage(msg.Completion);             
            }
        }


        loadingComplete = true;
        StateHasChanged();
    }

    private async Task UpdateSessionAndMessage(string sessionId, Message chatMessage)
    {

        //Update the tokens used in the session
        Session session = await cosmosDbService.GetSessionAsync(sessionId);

        //Insert new message and Update session in a transaction
        await cosmosDbService.UpsertSessionBatchAsync(session, chatMessage);

    }

    public static string StripOuterParagraphTags(string input)
    {
        if (string.IsNullOrEmpty(input))
        {
            return input;
        }

        // Use a regular expression to remove the outer <p> and </p> tags, case-insensitive
        string pattern = @"^\s*<p>(.*?)<\/p>?\s*$";
        return Regex.Replace(input, pattern, "$1", RegexOptions.IgnoreCase | RegexOptions.Singleline);
    }

    private void GoToProfile()
    {
        if (currentUser.Role!=UserRoles.Guest)
            NavigationManager.NavigateTo("/userprofile");
    }
}
